<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Watch Together 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { background-color: #000; color: white; overflow: hidden; }
        .heart {
            position: absolute;
            font-size: 2rem;
            animation: floatUp 2s ease-out forwards;
            pointer-events: none;
            z-index: 50;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-200px) scale(1.5); opacity: 0; }
        }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }
        
        /* Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ MP4 Ğ¿Ğ»ĞµĞµÑ€Ğ° */
        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- Ğ’Ğ’ĞĞ” Ğ¡Ğ¡Ğ«Ğ›ĞšĞ˜ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°) -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="controlPanel" class="bg-zinc-900 p-2 flex gap-2 z-20 shadow-lg border-b border-zinc-800">
        <input type="text" id="urlInput" placeholder="YouTube Ğ¸Ğ»Ğ¸ .mp4 ÑÑÑ‹Ğ»ĞºĞ°..." 
               class="flex-1 bg-zinc-800 text-white rounded px-3 py-2 text-sm outline-none border border-zinc-700 focus:border-blue-500">
        <button onclick="loadUserVideo()" class="bg-blue-600 px-3 py-2 rounded font-bold text-sm">PLAY</button>
        <button onclick="window.location.href='/gallery'" class="bg-zinc-700 px-3 py-2 rounded text-sm">ğŸ“Š</button>
    </div>
    
    <!-- Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ·Ñ€Ğ¸Ñ‚ĞµĞ»ĞµĞ¹ -->
    <div id="viewerNotice" class="hidden bg-zinc-800 p-2 text-center text-xs text-zinc-400 border-b border-zinc-700">
        ğŸ‘¤ Ğ’Ñ‹ Ğ·Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒ. Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ğ²Ğ¸Ğ´ĞµĞ¾.
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- Ğ’Ğ˜Ğ”Ğ•Ğ (YouTube Ğ˜Ğ›Ğ˜ MP4) -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="relative w-full bg-black shrink-0" style="height: 40vh;" id="videoContainer">
        <!-- YouTube Ğ¿Ğ»ĞµĞµÑ€ -->
        <div id="ytPlayer" class="w-full h-full absolute top-0 left-0 hidden"></div>
        
        <!-- MP4 Ğ¿Ğ»ĞµĞµÑ€ -->
        <video id="mp4Player" class="w-full h-full absolute top-0 left-0 hidden" controls></video>
        
        <!-- Placeholder -->
        <div id="placeholder" class="w-full h-full flex flex-col items-center justify-center text-zinc-500 text-sm gap-4">
            <div class="text-2xl">ğŸ¬</div>
            <div>ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ²Ğ¸Ğ´ĞµĞ¾...</div>
            <a href="/gallery" class="text-blue-400 text-xs underline">ğŸ“Š Ğ¡Ğ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ½Ğ°Ñ‚Ñ‹</a>
        </div>
        
        <!-- Ğ­Ğ¼Ğ¾Ñ†Ğ¸Ğ¸ -->
        <div id="emotionsContainer" class="absolute inset-0 pointer-events-none overflow-hidden z-10"></div>
        
        <!-- Ğ¡Ñ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº Ğ·Ñ€Ğ¸Ñ‚ĞµĞ»ĞµĞ¹ -->
        <div class="absolute top-2 right-2 bg-black/70 px-3 py-1 rounded-full text-xs">
            ğŸ‘¥ <span id="viewersCount">1</span>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- Ğ§ĞĞ¢ -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="chatContainer" class="flex-1 overflow-y-auto p-3 space-y-2 bg-zinc-950">
        <!-- Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ -->
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- ĞŸĞĞĞ•Ğ›Ğ¬ Ğ£ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯ -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="bg-zinc-900 p-2 pb-6 border-t border-zinc-800">
        <!-- Ğ­Ğ¼Ğ¾Ñ†Ğ¸Ğ¸ -->
        <div class="flex justify-center gap-6 mb-3">
            <button onclick="sendEmotion('â¤ï¸')" class="text-2xl hover:scale-110 transition">â¤ï¸</button>
            <button onclick="sendEmotion('ğŸ”¥')" class="text-2xl hover:scale-110 transition">ğŸ”¥</button>
            <button onclick="sendEmotion('ğŸ˜‚')" class="text-2xl hover:scale-110 transition">ğŸ˜‚</button>
            <button onclick="sendEmotion('ğŸ˜±')" class="text-2xl hover:scale-110 transition">ğŸ˜±</button>
            <button onclick="sendEmotion('ğŸ’€')" class="text-2xl hover:scale-110 transition">ğŸ’€</button>
        </div>
        <!-- Ğ’Ğ²Ğ¾Ğ´ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ -->
        <form onsubmit="sendMessage(event)" class="flex gap-2">
            <input type="text" id="chatInput" placeholder="Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ..." 
                   class="flex-1 bg-zinc-800 text-white rounded px-3 py-2 text-sm outline-none">
            <button type="submit" class="text-blue-400 font-bold px-2">â¤</button>
        </form>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // USER & ROOM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const user = tg.initDataUnsafe.user || { first_name: "Ğ“Ğ¾ÑÑ‚ÑŒ" + Math.floor(Math.random() * 1000) };
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('start_param') || urlParams.get('room') || "main";

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // WEBSOCKET
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const ws = new WebSocket(`${protocol}://${window.location.host}/ws/${roomId}/${user.first_name}`);

        let ytPlayer;
        let mp4Player = document.getElementById('mp4Player');
        let isRemoteAction = false;
        let isOwner = false;
        let currentSource = null;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // YOUTUBE API
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            console.log("âœ… YouTube API Ready");
            ytPlayer = new YT.Player('ytPlayer', {
                height: '100%',
                width: '100%',
                videoId: '',
                playerVars: { 
                    'playsinline': 1, 
                    'modestbranding': 1,
                    'origin': window.location.origin
                },
                events: {
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        }

        function onPlayerError(event) {
            console.error("âŒ YouTube Error:", event.data);
            tg.showAlert("YouTube Ğ½Ğµ Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞ¸Ğ» Ğ²Ğ¾ÑĞ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ Ğ´Ñ€ÑƒĞ³Ğ¾Ğµ Ğ²Ğ¸Ğ´ĞµĞ¾.");
        }

        function onPlayerStateChange(event) {
            if (isRemoteAction || !isOwner) return; // Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚
            
            if (event.data === YT.PlayerState.PLAYING) {
                ws.send(JSON.stringify({ 
                    type: 'sync_action', 
                    action: 'play', 
                    time: ytPlayer.getCurrentTime() 
                }));
            } else if (event.data === YT.PlayerState.PAUSED) {
                ws.send(JSON.stringify({ 
                    type: 'sync_action', 
                    action: 'pause', 
                    time: ytPlayer.getCurrentTime() 
                }));
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MP4 PLAYER EVENTS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        mp4Player.addEventListener('play', () => {
            if (isRemoteAction || !isOwner) return;
            ws.send(JSON.stringify({ 
                type: 'sync_action', 
                action: 'play', 
                time: mp4Player.currentTime 
            }));
        });

        mp4Player.addEventListener('pause', () => {
            if (isRemoteAction || !isOwner) return;
            ws.send(JSON.stringify({ 
                type: 'sync_action', 
                action: 'pause', 
                time: mp4Player.currentTime 
            }));
        });

        mp4Player.addEventListener('seeked', () => {
            if (isRemoteAction || !isOwner) return;
            ws.send(JSON.stringify({ 
                type: 'sync_action', 
                action: 'seek', 
                time: mp4Player.currentTime 
            }));
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // WS HANDLER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);

            // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
            if (data.type === 'init') {
                isOwner = data.is_owner;
                updateUIForRole();
                
                if (data.url) {
                    loadVideo(data.url, data.source);
                }
                
                document.getElementById('viewersCount').textContent = data.viewers;
            }

            // Ğ¡Ğ¼ĞµĞ½Ğ° Ğ²Ğ¸Ğ´ĞµĞ¾
            if (data.type === 'change_video') {
                loadVideo(data.url, data.source);
            }

            // Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
            if (data.type === 'sync_action') {
                isRemoteAction = true;
                
                if (currentSource === 'youtube' && ytPlayer && ytPlayer.playVideo) {
                    // Ğ£Ğ¼Ğ½Ğ°Ñ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ: Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ğ´ĞµĞ»ÑŒÑ‚Ğ° > 2 ÑĞµĞº
                    if (Math.abs(ytPlayer.getCurrentTime() - data.time) > 2.0) {
                        ytPlayer.seekTo(data.time);
                    }
                    data.action === 'play' ? ytPlayer.playVideo() : ytPlayer.pauseVideo();
                } 
                else if (currentSource === 'mp4') {
                    if (Math.abs(mp4Player.currentTime - data.time) > 2.0) {
                        mp4Player.currentTime = data.time;
                    }
                    data.action === 'play' ? mp4Player.play() : mp4Player.pause();
                }
                
                setTimeout(() => { isRemoteAction = false; }, 500);
            }

            // Ğ§Ğ°Ñ‚
            if (data.type === 'chat') {
                addChatMessage(data.user, data.text);
            }

            // Ğ­Ğ¼Ğ¾Ñ†Ğ¸Ğ¸
            if (data.type === 'emotion') {
                showEmotion(data.emoji);
            }

            // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ñ€Ğ¸Ñ‚ĞµĞ»ĞµĞ¹
            if (data.type === 'viewers_update') {
                document.getElementById('viewersCount').textContent = data.count;
            }

            // ĞÑˆĞ¸Ğ±ĞºĞ° (Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ²)
            if (data.type === 'error') {
                tg.showAlert(data.message);
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function updateUIForRole() {
            if (!isOwner) {
                document.getElementById('controlPanel').classList.add('hidden');
                document.getElementById('viewerNotice').classList.remove('hidden');
            }
        }

        function loadUserVideo() {
            const url = document.getElementById('urlInput').value.trim();
            if (!url) {
                tg.showAlert("Ğ’ÑÑ‚Ğ°Ğ²ÑŒ ÑÑÑ‹Ğ»ĞºÑƒ!");
                return;
            }
            
            ws.send(JSON.stringify({ 
                type: 'change_video', 
                url: url
            }));
        }

        function loadVideo(url, source) {
            currentSource = source;
            
            // Ğ¡ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ²ÑÑ‘
            document.getElementById('placeholder').style.display = 'none';
            document.getElementById('ytPlayer').classList.add('hidden');
            document.getElementById('mp4Player').classList.add('hidden');
            
            if (source === 'youtube') {
                // YouTube
                document.getElementById('ytPlayer').classList.remove('hidden');
                if (ytPlayer && ytPlayer.loadVideoById) {
                    ytPlayer.loadVideoById(url);
                }
            } 
            else if (source === 'mp4') {
                // MP4
                document.getElementById('mp4Player').classList.remove('hidden');
                mp4Player.src = url;
                mp4Player.load();
            }
        }

        function sendMessage(e) {
            e.preventDefault();
            const input = document.getElementById('chatInput');
            if (input.value.trim()) {
                ws.send(JSON.stringify({ type: 'chat', text: input.value }));
                input.value = '';
            }
        }

        function addChatMessage(user, text) {
            const container = document.getElementById('chatContainer');
            const isSystem = user === 'System';
            const div = document.createElement('div');
            
            div.className = isSystem 
                ? 'text-center text-xs text-zinc-500 my-1' 
                : 'bg-zinc-800 p-2 rounded-lg text-sm mb-1';
            
            div.innerHTML = isSystem 
                ? text 
                : `<span class="text-blue-400 font-bold">${user}:</span> ${text}`;
                
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function sendEmotion(emoji) {
            ws.send(JSON.stringify({ type: 'emotion', emoji: emoji }));
            showEmotion(emoji);
        }

        function showEmotion(emoji) {
            const el = document.createElement('div');
            el.innerText = emoji;
            el.className = 'heart';
            el.style.left = Math.random() * 80 + 10 + '%';
            el.style.bottom = '20%';
            document.getElementById('emotionsContainer').appendChild(el);
            setTimeout(() => el.remove(), 2000);
            
            try { 
                tg.HapticFeedback.impactOccurred('light'); 
            } catch(e) {}
        }

        // ĞŸĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ñ‚ĞµÑ€Ğµ ÑĞ²ÑĞ·Ğ¸
        ws.onclose = () => {
            setTimeout(() => {
                tg.showAlert("Ğ¡Ğ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ñ‚ĞµÑ€ÑĞ½Ğ¾. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ.");
            }, 1000);
        };

        ws.onerror = (error) => {
            console.error("WebSocket Error:", error);
        };
    </script>
</body>
</html>
